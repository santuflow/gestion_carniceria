<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Registro de Proveedor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='proveedor.css') }}">
</head>
<body class="fondo-proveedor">
  <header class="topbar">
    <div class="topbar-inner">
      <h1 class="titulo">Perfil de Proveedor</h1>
      <a href="{{ url_for('proveedores') }}" class="btn volver">← Volver</a>
    </div>
  </header>

  <main class="proveedor-layout">
    <form id="form-proveedor" action="/publicar_proveedor" method="POST" enctype="multipart/form-data" class="proveedor-form">

      <!-- ========== Portada + Avatar (a prueba de balas) ========== -->
      <section class="perfil-visual">
        <!-- PORTADA -->
        <div class="portada-wrapper">
          <img id="preview-portada" class="portada"
               src="{{ portada_url or url_for('static', filename='img/portada-placeholder.jpg') }}"
               alt="Portada">
          <input type="file" id="portada-file" name="portada" accept="image/*" hidden>
          <!-- label dispara SIEMPRE el selector -->
          <label for="portada-file" class="cambiar-portada">Cambiar portada</label>
        </div>

        <!-- AVATAR -->
        <div class="avatar-wrapper" title="Cambiar foto de perfil">
          <img id="preview-avatar" class="avatar"
               src="{{ avatar_url or url_for('static', filename='img/avatar-placeholder.png') }}"
               alt="Avatar">
          <input type="file" id="avatar-file" name="avatar" accept="image/*" hidden>
          <!-- ambos labels disparan el selector -->
          <label for="avatar-file" class="avatar-overlay">Cambiar</label>
          <label for="avatar-file" class="avatar-action">Cambiar</label>
        </div>
      </section>

      <!-- ========== Datos generales ========== -->
      <section class="grid-datos">
        <div class="form-col">
          <label>Nombre del negocio</label>
          <input type="text" name="nombre" placeholder="Ej: Frigorífico La Buena Carne" required>

          <label>Dirección / zona</label>
          <input type="text" name="direccion" placeholder="Calle y localidad" required>

          <label>Zonas de reparto</label>
          <div class="zonas-wrapper">
            <div class="zonas-busqueda">
              <input type="text" id="filtro-zonas" placeholder="Buscar zona...">
              <div class="zonas-acciones">
                <button type="button" class="btn chico" id="btn-todas">Seleccionar todo</button>
                <button type="button" class="btn chico secundario" id="btn-limpiar">Limpiar</button>
              </div>
            </div>

            <div id="zonas-lista" class="zonas-lista">
              {% set zonas_opciones = [
                'Capital Federal','Zona Norte','Zona Sur','Zona Oeste','Avellaneda','Lanús','Quilmes','Berazategui',
                'Florencio Varela','La Plata','Ensenada','Monte Grande','Lomas de Zamora','Banfield','San Justo',
                'Castelar','Ituzaingó','Haedo','Moreno','Merlo','Pilar','Escobar','San Miguel','José C. Paz',
                'Villa Ballester','San Martín','San Isidro','Vicente López','Tigre','San Fernando','Luján','Campana','Zárate'
              ] %}
              {% for z in zonas_opciones %}
              <label>
                <input type="checkbox" name="zonas_reparto[]" value="{{ z }}">
                <span>{{ z }}</span>
              </label>
              {% endfor %}
            </div>

            <div class="zonas-chips" id="zonas-chips"></div>
            <span class="help">Marcá todas las zonas que correspondan.</span>
          </div>
        </div>

        <div class="form-col">
          <label>Contacto (WhatsApp o teléfono)</label>
          <input type="text" name="contacto" placeholder="+54 9 11 1234-5678" required>

          <label>Descripción general</label>
          <textarea name="descripcion" rows="4" placeholder="Ej: Reparto diario. Mayores y minoristas. Vacuno, cerdo, pollo, congelados..."></textarea>
        </div>
      </section>

      <!-- ========== PRODUCTOS ========== -->
      <section class="productos-bloque">
        <div class="productos-header">
          <h2>Productos</h2>
          <button type="button" id="btn-agregar" class="btn secundario">+ Agregar otro producto</button>
        </div>

        <div id="productos-container" class="productos-grid"></div>

        <!-- Template para clonar -->
        <template id="tpl-producto">
          <div class="producto-item">
            <div class="producto-top">
              <div class="producto-foto">
                <img class="preview-imagen" alt="Vista previa" />
                <div class="foto-actions">
                  <label class="btn archivo small">
                    Subir foto
                    <input type="file" name="producto_imagen[]" accept="image/*" class="input-foto" hidden>
                  </label>
                  <button type="button" class="btn secundario small btn-cambiar" hidden>Cambiar</button>
                  <button type="button" class="btn secundario small btn-quitar" hidden>Quitar</button>
                </div>
                <div class="foto-hint">JPG/PNG/WebP • mín. 300×300 • máx. 3MB</div>
                <div class="msg-error" aria-live="polite"></div>
              </div>

              <div class="producto-campos">
                <div class="campo">
                  <label>Nombre</label>
                  <input type="text" name="producto_nombre[]" placeholder="Ej: Nalga" required>
                </div>

                <div class="campo precio-campo">
                  <label>Precio</label>
                  <input type="number" name="producto_precio[]" placeholder="Ej: 4500" min="0.01" step="0.01" inputmode="decimal" required>
                  <small class="precio-preview" aria-live="polite"></small>
                </div>

                <div class="campo">
                  <label>Unidad</label>
                  <select name="producto_unidad[]" required>
                    <option value="kg">kg</option>
                    <option value="unidad">unidad</option>
                    <option value="docena">docena</option>
                  </select>
                </div>

                <div class="campo">
                  <label>Categoría</label>
                  <select name="producto_categoria[]">
                    <option value="">(opcional)</option>
                    <option value="vacuno">Vacuno</option>
                    <option value="cerdo">Cerdo</option>
                    <option value="pollo">Pollo</option>
                    <option value="embutidos">Embutidos</option>
                    <option value="congelados">Congelados</option>
                    <option value="oferta">Oferta</option>
                  </select>
                </div>

                <div class="campo">
                  <label>Stock</label>
                  <input type="number" name="producto_stock[]" placeholder="(opcional)" min="0" step="1">
                </div>

                <div class="campo">
                  <label>Descripción</label>
                  <textarea name="producto_descripcion[]" rows="2" placeholder="(opcional) Detalles, origen, etc."></textarea>
                </div>

                <div class="switch-publicar">
                  <label class="switch">
                    <input type="checkbox" name="producto_publicar[]" checked>
                    <span class="slider"></span>
                  </label>
                  <span>Publicar</span>
                </div>
              </div>
            </div>

            <div class="producto-actions">
              <button type="button" class="btn peligro btn-eliminar">Eliminar</button>
            </div>
          </div>
        </template>
      </section>

      <div class="acciones">
        <button type="submit" class="btn publicar">Publicar proveedor</button>
      </div>
    </form>
  </main>

  <!-- =================== SCRIPTS =================== -->
  <script>
    // --- Preview portada y avatar (ids correctos) ---
    function preview(elInput, elImg){
      const f = elInput.files && elInput.files[0];
      if(!f) return;
      const reader = new FileReader();
      reader.onload = e => elImg.src = e.target.result;
      reader.readAsDataURL(f);
    }
    const portadaInput = document.getElementById('portada-file');
    const portadaImg   = document.getElementById('preview-portada');
    const avatarInput  = document.getElementById('avatar-file');
    const avatarImg    = document.getElementById('preview-avatar');
    portadaInput.addEventListener('change', () => preview(portadaInput, portadaImg));
    avatarInput.addEventListener('change', () => preview(avatarInput, avatarImg));

    // --- Zonas: filtro + chips + seleccionar/limpiar ---
    const lista = document.getElementById('zonas-lista');
    const filtro = document.getElementById('filtro-zonas');
    const chips = document.getElementById('zonas-chips');
    const btnTodas = document.getElementById('btn-todas');
    const btnLimpiar = document.getElementById('btn-limpiar');
    const form = document.getElementById('form-proveedor');

    filtro.addEventListener('input', () => {
      const q = filtro.value.toLowerCase().trim();
      [...lista.querySelectorAll('label')].forEach(lbl => {
        const txt = lbl.innerText.toLowerCase();
        lbl.style.display = txt.includes(q) ? 'flex' : 'none';
      });
    });
    function renderChips(){
      chips.innerHTML = '';
      lista.querySelectorAll('input[type="checkbox"]:checked').forEach(chk => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = chk.value;
        const x = document.createElement('button');
        x.type = 'button';
        x.textContent = '×';
        x.addEventListener('click', () => { chk.checked = false; renderChips(); });
        span.appendChild(x);
        chips.appendChild(span);
      });
    }
    lista.addEventListener('change', renderChips);
    btnTodas.addEventListener('click', () => {
      lista.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = true);
      renderChips();
    });
    btnLimpiar.addEventListener('click', () => {
      lista.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
      renderChips();
    });
    form.addEventListener('submit', (e) => {
      if (!lista.querySelector('input[type="checkbox"]:checked')) {
        e.preventDefault();
        alert('Seleccioná al menos una zona de reparto.');
      }
    });
    renderChips();

    // --- Productos dinámicos ---
    (function(){
      const contenedor = document.getElementById('productos-container');
      const btnAgregar = document.getElementById('btn-agregar');
      const tpl = document.getElementById('tpl-producto');

      const MAX_MB = 3, MAX_BYTES = MAX_MB * 1024 * 1024;
      const ALLOWED = ['image/jpeg','image/png','image/webp'];
      const MIN_W = 300, MIN_H = 300;
      const fmtARS = new Intl.NumberFormat('es-AR',{style:'currency',currency:'ARS'});

      function checkDims(objectURL){
        return new Promise((res)=>{
          const i = new Image();
          i.onload = () => res(i.width>=MIN_W && i.height>=MIN_H);
          i.onerror = () => res(false);
          i.src = objectURL;
        });
      }

      function nuevaTarjeta(){
        const node = tpl.content.firstElementChild.cloneNode(true);

        const inputFoto = node.querySelector('.input-foto');
        const img = node.querySelector('.preview-imagen');
        const errorBox = node.querySelector('.msg-error');
        const btnCambiar = node.querySelector('.btn-cambiar');
        const btnQuitar = node.querySelector('.btn-quitar');
        const btnEliminar = node.querySelector('.btn-eliminar');
        const precioInput = node.querySelector('input[name="producto_precio[]"]');
        const precioPreview = node.querySelector('.precio-preview');

        img.style.display = 'none';

        // Al estar el input dentro del label .archivo, ya dispara solo.
        btnCambiar.addEventListener('click', ()=> inputFoto.click());
        btnQuitar.addEventListener('click', ()=>{
          inputFoto.value = '';
          img.src = ''; img.style.display = 'none';
          btnCambiar.hidden = true; btnQuitar.hidden = true;
          errorBox.textContent = '';
        });

        inputFoto.addEventListener('change', async (e)=>{
          errorBox.textContent='';
          const file = e.target.files && e.target.files[0];
          if(!file) return;
          if(!ALLOWED.includes(file.type)){ errorBox.textContent='Formato no permitido (JPG/PNG/WebP).'; e.target.value=''; return; }
          if(file.size>MAX_BYTES){ errorBox.textContent=`La imagen supera ${MAX_MB}MB.`; e.target.value=''; return; }
          const url = URL.createObjectURL(file);
          const ok = await checkDims(url);
          if(!ok){ errorBox.textContent=`Mínimo ${MIN_W}×${MIN_H}px.`; e.target.value=''; URL.revokeObjectURL(url); return; }
          img.src = url; img.style.display='block';
          btnCambiar.hidden = false; btnQuitar.hidden = false;
        });

        const updPrecio = ()=>{
          const val = parseFloat((precioInput.value||'').toString().replace(',','.'));
          precioPreview.textContent = isFinite(val)&&val>0 ? fmtARS.format(val) : '';
        };
        precioInput.addEventListener('input', updPrecio);
        precioInput.addEventListener('blur', updPrecio);

        btnEliminar.addEventListener('click', ()=>{
          node.remove();
          if(!contenedor.querySelector('.producto-item')) agregar();
        });

        return node;
      }

      function agregar(){ contenedor.appendChild(nuevaTarjeta()); }

      btnAgregar.addEventListener('click', agregar);
      agregar(); // uno mínimo
    })();
  </script>
</body>
</html>
